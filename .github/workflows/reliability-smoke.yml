name: Reliability Smoke

on:
  workflow_dispatch:
    inputs:
      sample:
        description: "How many fixtures to execute"
        required: false
        default: "2"
      max_matches:
        description: "Matches checked per fixture"
        required: false
        default: "1"
      fixture:
        description: "Optional fixture id filter (e.g. usa-mls)"
        required: false
        default: ""
      matrix_mode:
        description: "Fixture matrix mode (default|extended)"
        required: false
        default: "default"
      rotation_key:
        description: "Optional deterministic rotation key for extended mode"
        required: false
        default: ""
      rerun_failed:
        description: "Rerun only failed fixtures from a smoke artifact"
        required: false
        type: boolean
        default: false
      artifact:
        description: "Optional artifact path for rerun mode"
        required: false
        default: ""
  schedule:
    - cron: "15 6 * * 1"

jobs:
  reliability-smoke:
    runs-on: ubuntu-latest
    timeout-minutes: 35

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright Chromium
        run: npx playwright install --with-deps chromium

      - name: Run reliability smoke
        env:
          RELIABILITY_ALERT_WEBHOOK_URL: ${{ secrets.RELIABILITY_ALERT_WEBHOOK_URL }}
        run: |
          EXTRA_ARGS=""
          MATRIX_MODE_INPUT="${{ github.event.inputs.matrix_mode || 'default' }}"
          ROTATION_KEY_INPUT="${{ github.event.inputs.rotation_key || '' }}"

          if [ "${{ github.event_name }}" = "schedule" ]; then
            export RELIABILITY_SMOKE_MATRIX_MODE="extended"
            export RELIABILITY_SMOKE_ROTATION_KEY="$(date -u +%G-W%V)"
          else
            export RELIABILITY_SMOKE_MATRIX_MODE="${MATRIX_MODE_INPUT}"
            if [ -n "${ROTATION_KEY_INPUT}" ]; then
              export RELIABILITY_SMOKE_ROTATION_KEY="${ROTATION_KEY_INPUT}"
            fi
          fi

          if [ "${{ github.event.inputs.rerun_failed || 'false' }}" = "true" ]; then
            EXTRA_ARGS="$EXTRA_ARGS --rerun-failed"
            if [ -n "${{ github.event.inputs.artifact || '' }}" ]; then
              EXTRA_ARGS="$EXTRA_ARGS --artifact ${{ github.event.inputs.artifact }}"
            fi
          elif [ -n "${{ github.event.inputs.fixture || '' }}" ]; then
            EXTRA_ARGS="$EXTRA_ARGS --fixture ${{ github.event.inputs.fixture }}"
          fi
          npm run smoke:reliability -- \
            --sample "${{ github.event.inputs.sample || '2' }}" \
            --max-matches "${{ github.event.inputs.max_matches || '1' }}" \
            $EXTRA_ARGS

      - name: Generate reliability trend summary
        if: always()
        run: npm run trend:reliability -- --lookback-hours 168 --quiet

      - name: Upload smoke artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: reliability-smoke-artifacts
          path: .planning/artifacts/smoke/
          if-no-files-found: warn
          retention-days: 14

      - name: Upload reliability trend artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: reliability-trend-artifacts
          path: .planning/artifacts/reliability-trends/
          if-no-files-found: warn
          retention-days: 14
