---
phase: 07-alert-signal-controls
plan: "02"
type: execute
wave: 2
depends_on:
  - 07-01
files_modified:
  - src/reliability/alerts/index.js
  - src/reliability/alerts/payload.js
  - scripts/smoke-reliability.mjs
  - scripts/health-selectors.mjs
  - src/selector-health/health-check/reporting.js
  - README.md
autonomous: true
requirements:
  - RELY-10
must_haves:
  truths:
    - "Repeated identical failures inside cooldown are suppressed instead of emitting duplicate webhook alerts"
    - "First-occurrence failures and post-window failures still emit actionable alerts that include suppression-window summaries"
    - "Every dedupe decision is visible in runtime logs and persisted artifacts for operator auditability"
  artifacts:
    - "src/reliability/alerts/index.js applies pre-send dedupe decisions and returns suppression/emission metadata to callers"
    - "src/reliability/alerts/payload.js includes suppression summary context on emitted post-window alerts"
    - "scripts/smoke-reliability.mjs records per-signature dedupe outcomes in smoke result/report and logs operator-visible suppression traces"
    - "scripts/health-selectors.mjs records per-signature dedupe outcomes in selector-health result/report and logs operator-visible suppression traces"
    - "src/selector-health/health-check/reporting.js surfaces dedupe summary context in non-quiet output"
    - "README.md documents cooldown/dedupe configuration and audit fields operators can inspect"
  key_links:
    - "run failure result -> dedupe decision API -> suppress or publish path"
    - "suppression state snapshot -> script result enrichment -> persisted report artifact"
    - "post-cooldown emit decision -> payload summary context -> operator triage message"
---

<objective>
Integrate dedupe/cooldown decisions into reliability alert emission and observability surfaces.

Purpose: Enforce low-noise alert delivery while keeping operational visibility high through explicit suppression logging and artifact evidence.
Output: Suppression-aware notifier flow for smoke and selector-health, enriched emitted payload summaries, and runbook updates for operator control/audit.
</objective>

<execution_context>
@./.codex/get-shit-done/workflows/execute-plan.md
@./.codex/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/STATE.md
@.planning/phases/07-alert-signal-controls/07-CONTEXT.md
@.planning/phases/07-alert-signal-controls/07-01-PLAN.md

@src/reliability/alerts/index.js
@src/reliability/alerts/payload.js
@scripts/smoke-reliability.mjs
@scripts/health-selectors.mjs
@src/reliability/smoke/reporting.js
@src/selector-health/health-check/reporting.js
@README.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Apply dedupe decisions in alert send path and enrich emitted payloads</name>
  <files>src/reliability/alerts/index.js, src/reliability/alerts/payload.js</files>
  <action>Update alert send orchestration to run dedupe/cooldown evaluation before webhook publishing. If decision is suppress, skip publish and return structured suppression metadata; if emit, proceed with publish and include suppression-window summary fields when the emitted alert follows prior suppressions (count + first/last suppressed timestamps + cooldown window boundary). Keep existing failure-only/CI gating behavior intact and deterministic.</action>
  <verify><automated>node --check src/reliability/alerts/index.js src/reliability/alerts/payload.js</automated></verify>
  <done>Alerting API reliably distinguishes suppressed versus emitted outcomes and emitted payload summaries include suppression context when applicable.</done>
</task>

<task type="auto">
  <name>Task 2: Wire suppression-aware behavior into smoke and selector-health scripts with artifact audit trail</name>
  <files>scripts/smoke-reliability.mjs, scripts/health-selectors.mjs, src/selector-health/health-check/reporting.js</files>
  <action>Integrate dedupe decision metadata from alert API into both command scripts so each run records aggregated per-signature dedupe entries (signature key, firstSeen, lastSeen, suppressedCount, cooldownUntil, reason) in the result object that gets persisted. Log concise non-quiet suppression lines for operator awareness. Ensure each run artifact stores one rollup entry per signature, and post-cooldown emitted alerts include prior suppression summary while preserving existing command exit semantics.</action>
  <verify><automated>node --check scripts/smoke-reliability.mjs scripts/health-selectors.mjs src/selector-health/health-check/reporting.js</automated></verify>
  <done>Smoke and selector-health runs suppress in-window duplicate alerts and persist audit-ready dedupe decision rollups that operators can inspect in logs and JSON artifacts.</done>
</task>

<task type="auto">
  <name>Task 3: Document operator dedupe controls and troubleshooting/audit workflow</name>
  <files>README.md</files>
  <action>Document cooldown/dedupe policy controls (global defaults, per-source overrides, accepted duration string formats, invalid-config fallback behavior), plus where suppression evidence appears in logs/artifacts and how post-window alerts summarize suppressed duplicates. Include concrete operator examples for CI and local troubleshooting flows without changing default alert noise policy.</action>
  <verify><automated>rg -n \"dedupe|cooldown|suppressed|suppression|RELIABILITY_ALERT|selector_health|smoke\" README.md scripts/smoke-reliability.mjs scripts/health-selectors.mjs src/reliability/alerts/index.js src/reliability/alerts/payload.js</automated></verify>
  <done>Operators can configure dedupe behavior intentionally and audit suppression decisions from run output/artifacts without ambiguity.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] node --check src/reliability/alerts/index.js src/reliability/alerts/payload.js scripts/smoke-reliability.mjs scripts/health-selectors.mjs src/selector-health/health-check/reporting.js
- [ ] CI=true RELIABILITY_ALERT_WEBHOOK_URL=https://127.0.0.1.invalid RELIABILITY_ALERT_DEDUPE_COOLDOWN=15m npm run smoke:reliability -- --dry-run --fixture argentina-liga-profesional --quiet; test $? -ne 0
- [ ] CI=true RELIABILITY_ALERT_WEBHOOK_URL=https://127.0.0.1.invalid RELIABILITY_ALERT_DEDUPE_COOLDOWN=15m npm run health:selectors -- --dry-run --scope countries --sample 1 --quiet; test $? -eq 0 || true
- [ ] node -e "const fs=require('fs');const p='.planning/artifacts/smoke/latest.json';if(!fs.existsSync(p))process.exit(1);const j=JSON.parse(fs.readFileSync(p,'utf8'));const d=j.alertDedupe||j.alerts?.dedupe||null;if(!d)process.exit(1);"
- [ ] rg -n \"dedupe|cooldown|suppressed|suppression\" README.md .planning/artifacts/smoke/latest.json 2>/dev/null || true
</verification>

<success_criteria>

- All plan tasks completed
- In-window duplicates are suppressed and no duplicate alerts are emitted for identical signatures
- First/post-window failures still emit actionable alerts enriched with suppression summary context
- Dedupe decisions are observable in runtime logs and persisted artifacts for auditability
</success_criteria>

<output>
After completion, create .planning/phases/07-alert-signal-controls/07-02-SUMMARY.md
</output>
