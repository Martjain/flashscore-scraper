---
phase: 07-alert-signal-controls
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - src/reliability/alerts/config.js
  - src/reliability/alerts/dedupe-policy.js
  - src/reliability/alerts/dedupe-state.js
  - src/reliability/alerts/index.js
autonomous: true
requirements:
  - RELY-10
must_haves:
  truths:
    - "Alert emission policy is operator-configurable via global defaults with optional per-source overrides"
    - "Duplicate failures sharing the same signature inside cooldown are suppressed, while first and post-expiry failures remain emit-eligible"
    - "Deduplication uses a normalized, deterministic signature key so variable tokens do not create alert noise"
  artifacts:
    - "src/reliability/alerts/config.js resolves dedupe policy with duration parsing, override precedence, and invalid-config fallback behavior"
    - "src/reliability/alerts/dedupe-policy.js defines normalized signature construction and cooldown evaluation inputs/outputs"
    - "src/reliability/alerts/dedupe-state.js tracks per-signature first-seen, last-seen, cooldown-until, and suppressed-count state"
    - "src/reliability/alerts/index.js exposes stable APIs that return emit/suppress decisions plus audit-ready suppression metadata"
  key_links:
    - "run result context + source metadata -> signature normalization -> deterministic dedupe key"
    - "effective policy + signature state -> cooldown evaluator -> emit/suppress decision"
    - "suppression event -> state update -> next eligible post-window emission summary context"
---

<objective>
Build the alert dedupe/cooldown decision engine for Phase 7.

Purpose: Prevent repeated identical reliability failures from flooding operators while preserving actionable first-occurrence and post-window alerts.
Output: Configurable policy resolution, deterministic signature normalization, and sliding-window cooldown state evaluation ready for notifier integration.
</objective>

<execution_context>
@./.codex/get-shit-done/workflows/execute-plan.md
@./.codex/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/STATE.md
@.planning/phases/07-alert-signal-controls/07-CONTEXT.md

@src/reliability/alerts/config.js
@src/reliability/alerts/index.js
@src/reliability/alerts/payload.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add operator policy resolution for dedupe/cooldown controls</name>
  <files>src/reliability/alerts/config.js, src/reliability/alerts/dedupe-policy.js</files>
  <action>Introduce alert dedupe policy parsing that supports global defaults and optional per-source overrides (`smoke`, `selector_health`), with cooldown values accepted as duration strings (for example `15m`, `1h`). Enforce conservative defaults when configuration is missing, and treat malformed policy input as non-fatal: emit machine-readable diagnostics and fall back to last-known-valid/effective defaults instead of disabling alerting silently.</action>
  <verify><automated>node --check src/reliability/alerts/config.js src/reliability/alerts/dedupe-policy.js</automated></verify>
  <done>Alert policy resolution returns a validated effective dedupe policy plus diagnostics describing source, fallback, and override decisions for each run.</done>
</task>

<task type="auto">
  <name>Task 2: Implement normalized signature construction and sliding-window cooldown evaluation</name>
  <files>src/reliability/alerts/dedupe-policy.js, src/reliability/alerts/dedupe-state.js</files>
  <action>Implement deterministic alert signature creation using `fixture + checkType + normalizedErrorClass + region`, where error normalization strips variable tokens (timestamps, IDs, numeric fragments) before comparison. Add cooldown evaluation with sliding-window semantics anchored to the most recent suppressed duplicate, with explicit decision outputs (`emit`, `suppress`) and updated state fields (`firstSeen`, `lastSeen`, `cooldownUntil`, `suppressedCount`). Ensure signature changes (including workflow/environment/region context shifts) produce independent state keys.</action>
  <verify><automated>node --check src/reliability/alerts/dedupe-policy.js src/reliability/alerts/dedupe-state.js</automated></verify>
  <done>Given deterministic inputs and current state, evaluator outputs stable emit/suppress decisions and correct cooldown transitions across first-occurrence, in-window duplicate, and post-expiry events.</done>
</task>

<task type="auto">
  <name>Task 3: Expose dedupe decision API from alert module for script integration</name>
  <files>src/reliability/alerts/index.js, src/reliability/alerts/dedupe-policy.js, src/reliability/alerts/dedupe-state.js</files>
  <action>Extend the alert module public API with a pre-send decision entrypoint that composes effective policy resolution, signature generation, and state transitions. Return audit-ready decision metadata (signature key, reason, policy snapshot, suppression counts, window timestamps, and post-window carryover summary data) so scripts can suppress sends or emit enriched alerts without duplicating logic.</action>
  <verify><automated>node --check src/reliability/alerts/index.js src/reliability/alerts/dedupe-policy.js src/reliability/alerts/dedupe-state.js</automated></verify>
  <done>Scripts can call a single alert dedupe API to decide whether to emit an alert and receive complete context needed for logs, artifacts, and payload enrichment.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] node --check src/reliability/alerts/config.js src/reliability/alerts/dedupe-policy.js src/reliability/alerts/dedupe-state.js src/reliability/alerts/index.js
- [ ] node -e "import('./src/reliability/alerts/dedupe-policy.js').then(({buildAlertSignature,normalizeAlertErrorClass})=>{const a=normalizeAlertErrorClass('Timeout at 2026-02-28T12:33:44Z id=FIX-1234 #99');const b=normalizeAlertErrorClass('Timeout at 2026-03-01T09:00:00Z id=FIX-8888 #01');if(a!==b)process.exit(1);const key=buildAlertSignature({fixtureId:'argentina-liga-profesional',checkType:'smoke:matches',errorClass:a,region:'sa'});if(!key||!key.includes('argentina-liga-profesional'))process.exit(1);}).catch(()=>process.exit(1));"
- [ ] node -e "import('./src/reliability/alerts/index.js').then(({evaluateFailureAlertEmission})=>{const base={source:'smoke',event:{fixtureId:'argentina-liga-profesional',checkType:'smoke:matches',error:'timeout id=123',region:'sa'},env:{CI:'true'}};const first=evaluateFailureAlertEmission(base);const second=evaluateFailureAlertEmission(base);if(first.decision!=='emit'||second.decision!=='suppress')process.exit(1);}).catch(()=>process.exit(1));"
</verification>

<success_criteria>

- All plan tasks completed
- Dedupe/cooldown policy supports configurable defaults and per-source overrides with safe fallback behavior
- Signature normalization removes unstable tokens so duplicate failures collapse correctly
- Cooldown evaluation enforces first-occurrence + post-window emit behavior while suppressing in-window duplicates
</success_criteria>

<output>
After completion, create .planning/phases/07-alert-signal-controls/07-01-SUMMARY.md
</output>
