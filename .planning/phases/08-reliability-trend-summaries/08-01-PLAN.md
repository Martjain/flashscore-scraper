---
phase: 08-reliability-trend-summaries
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - src/reliability/trends/history-loader.js
  - src/reliability/trends/aggregation.js
  - src/reliability/trends/signature-parser.js
  - src/reliability/trends/index.js
autonomous: true
requirements:
  - RELY-11
must_haves:
  truths:
    - "Trend generation can read historical smoke and selector-health artifacts inside a selectable lookback window"
    - "Failures are summarized by fixture and by region with counts and rates derived from persisted run history"
    - "Missing, malformed, or partial artifact history is surfaced as explicit diagnostics instead of silent data loss"
  artifacts:
    - "src/reliability/trends/history-loader.js loads bounded smoke/selector-health artifact history and emits source diagnostics"
    - "src/reliability/trends/signature-parser.js normalizes reliability signatures and fallback metadata into stable fixture/region keys"
    - "src/reliability/trends/aggregation.js builds grouped failure/run metrics for fixture and region trend summaries"
    - "src/reliability/trends/index.js exposes a stable aggregation API that downstream scripts can call"
  key_links:
    - "artifact files + lookback boundary -> normalized event stream -> trend input dataset"
    - "normalized event stream -> fixture/region grouping logic -> failure counts and failure-rate calculations"
    - "loader parse/shape issues -> diagnostics collector -> operator-visible partial-history warnings"
---

<objective>
Build the trend aggregation foundation for reliability summaries.

Purpose: Turn persisted smoke and selector-health artifacts into deterministic, lookback-bounded trend data operators can trust.
Output: Reusable trend data loader + normalizer + aggregator modules with diagnostics for partial history.
</objective>

<execution_context>
@./.codex/get-shit-done/workflows/execute-plan.md
@./.codex/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/STATE.md

@scripts/smoke-reliability.mjs
@scripts/health-selectors.mjs
@src/reliability/smoke/reporting.js
@src/selector-health/health-check/reporting.js
@.planning/artifacts/smoke/latest.json
@.planning/artifacts/selector-health/latest.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add bounded artifact-history loader with lookback and source diagnostics</name>
  <files>src/reliability/trends/history-loader.js</files>
  <action>Create a history loader that scans smoke and selector-health artifact directories, reads JSON files within a selectable lookback window, and returns normalized run records plus diagnostics (files considered, files skipped outside window, parse failures, missing directories, and missing required fields). Keep loading resilient: malformed files must not abort aggregation, but they must be captured in diagnostics with file path and reason.</action>
  <verify><automated>node --check src/reliability/trends/history-loader.js</automated></verify>
  <done>Loader returns deterministic run-history input for both reliability sources and provides explicit diagnostics when history is incomplete or malformed.</done>
</task>

<task type="auto">
  <name>Task 2: Normalize reliability events and aggregate fixture/region trend metrics</name>
  <files>src/reliability/trends/signature-parser.js, src/reliability/trends/aggregation.js</files>
  <action>Implement normalization helpers that extract stable fixture and region identifiers from artifact payloads (prefer explicit fields, then dedupe signature parsing, then safe fallbacks like `global` region). Build aggregation that computes per-fixture and per-region totals for runs, failed runs, failure counts, and failure rates over the selected window. Ensure both smoke and selector-health events are represented so mixed history still produces complete grouped summaries.</action>
  <verify><automated>node --check src/reliability/trends/signature-parser.js src/reliability/trends/aggregation.js</automated></verify>
  <done>Aggregator produces grouped fixture/region summary objects with reproducible counts/rates and no uncategorized failures unless explicitly flagged in diagnostics.</done>
</task>

<task type="auto">
  <name>Task 3: Expose trend summary contract API for downstream command/reporting flows</name>
  <files>src/reliability/trends/index.js, src/reliability/trends/history-loader.js, src/reliability/trends/aggregation.js</files>
  <action>Export a single orchestrating API that accepts lookback options and returns a stable summary contract containing window metadata, source coverage, grouped fixture/region metrics, and diagnostics. Include contract guards that preserve key presence (`window`, `totals`, `byFixture`, `byRegion`, `diagnostics`) even when history is sparse so downstream CLI and CI usage stays schema-stable.</action>
  <verify><automated>node --check src/reliability/trends/index.js src/reliability/trends/history-loader.js src/reliability/trends/aggregation.js</automated></verify>
  <done>Downstream callers can generate trend summaries from one API call and always receive stable contract keys plus explicit diagnostics for sparse history.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] node --check src/reliability/trends/history-loader.js src/reliability/trends/signature-parser.js src/reliability/trends/aggregation.js src/reliability/trends/index.js
- [ ] node -e "import('./src/reliability/trends/index.js').then(async ({buildReliabilityTrendSummary})=>{const summary=await buildReliabilityTrendSummary({lookbackHours:168});if(!summary||!summary.window||!summary.diagnostics||!Array.isArray(summary.byFixture)||!Array.isArray(summary.byRegion))process.exit(1);}).catch(()=>process.exit(1));"
- [ ] node -e "import('./src/reliability/trends/signature-parser.js').then(({parseReliabilitySignature})=>{const parsed=parseReliabilitySignature('source:smoke|env:ci|workflow:dry-run|fixture:argentina-liga-profesional|check:smoke:selection|error:no_matching_fixtures|region:sa');if(parsed.fixture!=='argentina-liga-profesional'||parsed.region!=='sa')process.exit(1);}).catch(()=>process.exit(1));"
</verification>

<success_criteria>

- All plan tasks completed
- Trend aggregation reads persisted reliability history using an operator-selectable lookback window
- Summary output includes grouped fixture and region failure metrics with deterministic counts/rates
- Partial or malformed history generates explicit diagnostics without breaking summary generation
</success_criteria>

<output>
After completion, create .planning/phases/08-reliability-trend-summaries/08-01-SUMMARY.md
</output>
