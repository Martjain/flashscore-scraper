---
phase: 06-rotating-regional-matrix
plan: "02"
type: execute
wave: 2
depends_on:
  - 06-01
files_modified:
  - scripts/smoke-reliability.mjs
  - .github/workflows/reliability-smoke.yml
  - README.md
autonomous: true
requirements:
  - RELY-09
must_haves:
  truths:
    - "Scheduled reliability smoke can opt into extended regional rotation without changing default/manual smoke behavior"
    - "Routine smoke runs keep bounded runtime characteristics by staying on default matrix mode unless explicitly overridden"
    - "Extended run artifacts clearly expose region rotation inputs and selected fixtures for reproducible debugging"
  artifacts:
    - "scripts/smoke-reliability.mjs forwards matrix mode/rotation options into smoke runner and reports selection metadata"
    - ".github/workflows/reliability-smoke.yml enables extended mode for schedule path while preserving existing manual dispatch defaults"
    - "README.md documents default vs extended mode behavior, reproducibility knobs, and artifact fields"
  key_links:
    - "workflow schedule branch -> extended mode env/args -> smoke command runtime options"
    - "smoke script options -> runSmokeSuite selection -> persisted artifact metadata"
    - "README operational guidance -> workflow inputs/env usage -> reproducible reruns/debug flow"
---

<objective>
Wire the Phase 6 selection foundation into scheduled operations and operator documentation.

Purpose: Deliver extended regional coverage on schedule while preserving fast, bounded defaults for local and routine CI use.
Output: Script + workflow integration for extended mode and updated runbook guidance for reproducible regional debugging.
</objective>

<execution_context>
@./.codex/get-shit-done/workflows/execute-plan.md
@./.codex/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/STATE.md
@.planning/phases/06-rotating-regional-matrix/06-RESEARCH.md
@.planning/phases/06-rotating-regional-matrix/06-01-PLAN.md

@scripts/smoke-reliability.mjs
@.github/workflows/reliability-smoke.yml
@README.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Thread matrix mode and rotation controls through smoke entrypoint</name>
  <files>scripts/smoke-reliability.mjs</files>
  <action>Update smoke script orchestration to consume parsed matrix mode/rotation options (and environment defaults intended for CI schedule) and forward them to `runSmokeSuite`. Ensure existing command outputs and exit semantics are preserved, then print/record selection metadata in non-quiet output so operators can immediately see which regional rotation was executed. Do not force extended mode in code defaults; behavior must remain opt-in.</action>
  <verify><automated>node --check scripts/smoke-reliability.mjs</automated></verify>
  <done>Smoke script supports explicit extended mode inputs and surfaces deterministic selection metadata without changing default pass/fail behavior.</done>
</task>

<task type="auto">
  <name>Task 2: Enable scheduled extended matrix coverage with deterministic rotation keying</name>
  <files>.github/workflows/reliability-smoke.yml</files>
  <action>Modify workflow run logic so scheduled executions opt into extended regional mode and pass a deterministic rotation key (for example ISO week token) while workflow_dispatch/manual invocations keep current bounded defaults unless explicitly requested. Keep existing alert env wiring and artifact upload behavior intact.</action>
  <verify><automated>rg -n \"RELIABILITY_SMOKE_MATRIX_MODE|RELIABILITY_SMOKE_ROTATION_KEY|schedule|workflow_dispatch|smoke:reliability\" .github/workflows/reliability-smoke.yml</automated></verify>
  <done>Scheduled jobs run with reproducible extended regional rotation and manual runs preserve prior defaults.</done>
</task>

<task type="auto">
  <name>Task 3: Document extended regional mode and artifact reproducibility contract</name>
  <files>README.md</files>
  <action>Document matrix mode controls (default vs extended), how rotation keys are derived/passed, and where selected region/fixture metadata appears in smoke artifacts. Include explicit guidance that default smoke remains bounded for routine checks and that extended mode is intended for scheduled coverage expansion.</action>
  <verify><automated>rg -n \"extended|region|rotation|matrix mode|RELIABILITY_SMOKE_MATRIX_MODE|selection metadata|artifact\" README.md</automated></verify>
  <done>Operators can run and debug extended regional smoke deterministically while understanding that default mode remains unchanged.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] node --check scripts/smoke-reliability.mjs
- [ ] RELEVANT=1 npm run smoke:reliability -- --dry-run --sample 2 --quiet
- [ ] RELIABILITY_SMOKE_MATRIX_MODE=extended RELIABILITY_SMOKE_ROTATION_KEY=2026-W09 npm run smoke:reliability -- --dry-run --sample 2 --report /tmp/smoke-extended-phase6.json --quiet
- [ ] node -e "const fs=require('fs');const r=JSON.parse(fs.readFileSync('/tmp/smoke-extended-phase6.json','utf8'));if(!r.selection||r.selection.mode!=='extended'||!Array.isArray(r.selection.fixtureIds))process.exit(1);"
- [ ] rg -n "RELIABILITY_SMOKE_MATRIX_MODE|RELIABILITY_SMOKE_ROTATION_KEY|extended|rotation|selection" .github/workflows/reliability-smoke.yml README.md scripts/smoke-reliability.mjs
</verification>

<success_criteria>

- All plan tasks completed
- Scheduled workflow supports deterministic extended regional coverage
- Default smoke command behavior and bounded runtime profile remain unchanged
- Extended artifacts expose enough selection metadata to reproduce/debug exact runs
</success_criteria>

<output>
After completion, create .planning/phases/06-rotating-regional-matrix/06-02-SUMMARY.md
</output>
