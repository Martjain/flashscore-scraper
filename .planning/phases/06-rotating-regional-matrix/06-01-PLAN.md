---
phase: 06-rotating-regional-matrix
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - src/reliability/smoke/fixture-matrix.js
  - src/cli/arguments/index.js
  - src/reliability/smoke/run-smoke-suite.js
autonomous: true
requirements:
  - RELY-09
must_haves:
  truths:
    - "Extended smoke mode selects fixtures through deterministic region rotation for a given rotation key"
    - "Default smoke behavior remains bounded and backward-compatible when extended mode is not enabled"
    - "Smoke result artifacts include reproducible selection metadata (mode, rotation key, region token, fixture IDs)"
  artifacts:
    - "src/reliability/smoke/fixture-matrix.js defines region-aware matrix entries plus deterministic selection helpers"
    - "src/cli/arguments/index.js parses and validates matrix mode + rotation arguments without breaking existing flags"
    - "src/reliability/smoke/run-smoke-suite.js applies extended/default selection and records selection provenance in result output"
  key_links:
    - "CLI/env selection options -> fixture selector policy -> actual fixture list executed"
    - "rotation key + region metadata -> deterministic region/fixture selection -> repeatable output"
    - "final fixture selection -> smoke result payload selection block -> persisted smoke artifact"
---

<objective>
Implement the region-aware deterministic fixture selection foundation for Phase 6.

Purpose: Expand reliability coverage in a predictable way while preserving the fast default smoke path.
Output: Region-tagged fixture matrix, deterministic rotation selector, and artifact-ready selection metadata in smoke results.
</objective>

<execution_context>
@./.codex/get-shit-done/workflows/execute-plan.md
@./.codex/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/STATE.md
@.planning/phases/06-rotating-regional-matrix/06-RESEARCH.md

@src/reliability/smoke/fixture-matrix.js
@src/cli/arguments/index.js
@src/reliability/smoke/run-smoke-suite.js
@scripts/smoke-reliability.mjs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add region metadata and deterministic rotation helpers to smoke matrix</name>
  <files>src/reliability/smoke/fixture-matrix.js</files>
  <action>Extend each fixture entry with explicit region metadata and implement a deterministic extended selector that accepts `matrixMode`, `rotationKey`, `sample`, and optional `fixtureIds`. Keep default path behavior unchanged (`slice(0, sample)` when mode is default or explicit fixture filter is used). For extended mode, compute a stable region slot/token from the rotation key, choose eligible fixtures in deterministic order, and return both selected fixtures and selection metadata needed for artifact traceability.</action>
  <verify><automated>node --check src/reliability/smoke/fixture-matrix.js</automated></verify>
  <done>Fixture matrix exports can deterministically return the same extended fixture subset for the same input key while preserving existing default selection behavior.</done>
</task>

<task type="auto">
  <name>Task 2: Parse matrix-mode and rotation inputs with strict argument compatibility</name>
  <files>src/cli/arguments/index.js</files>
  <action>Add smoke CLI parsing support for matrix mode and rotation key inputs (flags and/or environment-backed defaults) with validation that avoids breaking existing options. Ensure `--fixture` retains precedence for explicit operator targeting, and invalid mode values fail with actionable errors instead of silently falling back. Do not alter existing defaults for `sample`, `max-matches`, `timeout`, and rerun behavior.</action>
  <verify><automated>node --check src/cli/arguments/index.js</automated></verify>
  <done>Smoke options object includes validated matrix selection settings, and all pre-existing smoke argument combinations continue to parse as before.</done>
</task>

<task type="auto">
  <name>Task 3: Apply region-aware selection in runner and persist selection provenance</name>
  <files>src/reliability/smoke/run-smoke-suite.js</files>
  <action>Wire the new selector into `runSmokeSuite` so it uses default or extended mode based on parsed options. Add a `selection` metadata block to output (mode, rotationKey, selectedRegion token, selected fixture IDs, and selection reason where applicable) and keep summary/result semantics unchanged. Preserve existing failure handling and schema-gate flow; this task should only alter selection inputs and observability metadata.</action>
  <verify><automated>node --check src/reliability/smoke/run-smoke-suite.js</automated></verify>
  <done>Smoke suite result includes deterministic selection provenance for extended mode and unchanged bounded behavior in default mode.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] node --check src/reliability/smoke/fixture-matrix.js src/cli/arguments/index.js src/reliability/smoke/run-smoke-suite.js
- [ ] node -e "import('./src/reliability/smoke/fixture-matrix.js').then(({selectSmokeFixtures})=>{const one=selectSmokeFixtures({sample:2,matrixMode:'extended',rotationKey:'2026-W09'}).map((f)=>f.fixtureId).join(',');const two=selectSmokeFixtures({sample:2,matrixMode:'extended',rotationKey:'2026-W09'}).map((f)=>f.fixtureId).join(',');if(one!==two)process.exit(1);}).catch(()=>process.exit(1));"
- [ ] node -e "import('./src/reliability/smoke/run-smoke-suite.js').then(async ({runSmokeSuite})=>{const r=await runSmokeSuite({dryRun:true,sample:2,matrixMode:'extended',rotationKey:'2026-W09'});if(!r.selection||!r.selection.rotationKey||!Array.isArray(r.selection.fixtureIds))process.exit(1);}).catch(()=>process.exit(1));"
</verification>

<success_criteria>

- All plan tasks completed
- Region-aware deterministic selection exists for extended mode
- Default bounded smoke selection remains unchanged when extended mode is not enabled
- Smoke output carries reproducible selection metadata required for debugging and reruns
</success_criteria>

<output>
After completion, create .planning/phases/06-rotating-regional-matrix/06-01-SUMMARY.md
</output>
