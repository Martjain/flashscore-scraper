---
phase: 04-failed-fixture-reruns
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - src/reliability/smoke/rerun-fixtures.js
  - src/cli/arguments/index.js
  - src/reliability/smoke/fixture-matrix.js
autonomous: true
requirements:
  - RELY-07
must_haves:
  truths:
    - "Rerun mode can deterministically derive failed fixture IDs from the latest smoke artifact"
    - "Selection excludes passed fixtures and ignores non-fixture pseudo-failures"
    - "Invalid or missing artifact inputs are detected with actionable fallback guidance"
  artifacts:
    - "src/reliability/smoke/rerun-fixtures.js provides artifact parsing and failed-fixture selection helpers"
    - "src/cli/arguments/index.js supports rerun-specific CLI flags and validation"
    - "src/reliability/smoke/fixture-matrix.js exposes fixture identity helpers used to validate rerun candidates"
  key_links:
    - "smoke artifact fixtures[] -> rerun selector helper -> validated failed fixture ID list"
    - "CLI rerun flags -> parsed options object -> rerun selector inputs"
    - "fixture matrix IDs -> selector validation -> safe rerunnable fixture set"
---

<objective>
Implement the failed-fixture selection foundation for rerun mode.

Purpose: Convert smoke artifact failures into a safe rerun fixture list before script-level orchestration.
Output: Reusable rerun selection module and CLI option contract for rerun mode inputs.
</objective>

<execution_context>
@./.codex/get-shit-done/workflows/execute-plan.md
@./.codex/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/STATE.md
@.planning/phases/04-failed-fixture-reruns/04-RESEARCH.md

@src/cli/arguments/index.js
@src/reliability/smoke/fixture-matrix.js
@src/reliability/smoke/run-smoke-suite.js
@.planning/artifacts/smoke/latest.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add artifact-driven rerun fixture selector helpers</name>
  <files>src/reliability/smoke/rerun-fixtures.js</files>
  <action>Create rerun helper functions to load/parse a smoke artifact JSON file (defaulting to `.planning/artifacts/smoke/latest.json`), validate required shape (`fixtures` array with status + fixtureId fields), and derive failed fixture IDs only from fixture-level failures. Exclude synthetic issue IDs (for example `run` and `schema-gate`) and return structured diagnostics describing selected, ignored, and invalid fixture IDs.</action>
  <verify><automated>node --check src/reliability/smoke/rerun-fixtures.js</automated></verify>
  <done>Helper module returns deterministic rerun candidate fixture IDs from valid artifacts and returns explicit error objects for missing/invalid artifacts.</done>
</task>

<task type="auto">
  <name>Task 2: Extend smoke argument parsing with rerun flags</name>
  <files>src/cli/arguments/index.js</files>
  <action>Extend `parseSmokeReliabilityArguments` to support `--rerun-failed` (boolean) and `--artifact <path>` (optional override). Add validation rules so rerun intent is explicit and predictable (for example disallow empty artifact path values and normalize duplicate fixture IDs). Keep existing flags backward compatible and preserve current defaults for non-rerun mode.</action>
  <verify><automated>node --check src/cli/arguments/index.js</automated></verify>
  <done>CLI options object includes rerun controls without regressing existing smoke flag behavior.</done>
</task>

<task type="auto">
  <name>Task 3: Expose fixture identity helper(s) for rerun validation</name>
  <files>src/reliability/smoke/fixture-matrix.js, src/reliability/smoke/rerun-fixtures.js</files>
  <action>Add or export helper(s) that provide the canonical set of configured fixture IDs so rerun selection can validate artifact-derived failures against the current fixture matrix. Unknown fixture IDs should be surfaced as ignored/invalid diagnostics instead of causing ambiguous rerun behavior.</action>
  <verify><automated>node --check src/reliability/smoke/fixture-matrix.js src/reliability/smoke/rerun-fixtures.js</automated></verify>
  <done>Rerun selector can reliably separate valid rerunnable fixture IDs from stale/unknown artifact entries.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] node --check src/reliability/smoke/rerun-fixtures.js src/reliability/smoke/fixture-matrix.js src/cli/arguments/index.js
- [ ] node -e "import('./src/reliability/smoke/rerun-fixtures.js').then(m=>{if(!m)process.exit(1);}).catch(()=>process.exit(1));"
- [ ] node -e "import('./src/cli/arguments/index.js').then(m=>{const o=m.parseSmokeReliabilityArguments(['--rerun-failed']);if(!o.rerunFailed)process.exit(1);}).catch(()=>process.exit(1));"
</verification>

<success_criteria>

- All plan tasks completed
- Failed fixture selection reads artifact data and ignores passed fixtures
- Rerun CLI options are parsed and validated without breaking current smoke usage
- Selection diagnostics distinguish rerunnable vs invalid fixture IDs
</success_criteria>

<output>
After completion, create .planning/phases/04-failed-fixture-reruns/04-01-SUMMARY.md
</output>
