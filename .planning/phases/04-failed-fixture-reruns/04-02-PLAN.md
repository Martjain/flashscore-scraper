---
phase: 04-failed-fixture-reruns
plan: "02"
type: execute
wave: 2
depends_on:
  - 04-01
files_modified:
  - scripts/smoke-reliability.mjs
  - README.md
  - .github/workflows/reliability-smoke.yml
autonomous: true
requirements:
  - RELY-07
must_haves:
  truths:
    - "Operator can invoke rerun mode that automatically targets failed fixtures from the latest smoke artifact"
    - "Rerun mode fails with a clear actionable message when artifact data is missing or invalid"
    - "Rerun execution still emits standard smoke artifacts and preserves CI-compatible pass/fail exit behavior"
  artifacts:
    - "scripts/smoke-reliability.mjs wires rerun mode into existing smoke execution, schema gate, reporting, and exit semantics"
    - "README.md documents rerun command usage, artifact requirements, and manual fallback path"
    - ".github/workflows/reliability-smoke.yml supports operator-triggered rerun mode in workflow_dispatch inputs"
  key_links:
    - "CLI rerun flags -> rerun selector helper -> runSmokeSuite fixtureIds option"
    - "rerun-mode smoke result -> persistSmokeReport -> .planning/artifacts/smoke/latest.json"
    - "artifact read/validation failures -> RESULT: fail + non-zero exit -> manual --fixture fallback guidance"
---

<objective>
Wire failed-fixture rerun mode into smoke command execution and operator workflow.

Purpose: Deliver a production-usable recovery path that reruns only unresolved smoke failures while preserving current reporting and CI semantics.
Output: Rerun-capable smoke command + docs/workflow updates for routine operations.
</objective>

<execution_context>
@./.codex/get-shit-done/workflows/execute-plan.md
@./.codex/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/STATE.md
@.planning/phases/04-failed-fixture-reruns/04-RESEARCH.md
@.planning/phases/04-failed-fixture-reruns/04-01-PLAN.md

@scripts/smoke-reliability.mjs
@README.md
@.github/workflows/reliability-smoke.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Inject rerun-failed selection into smoke script orchestration</name>
  <files>scripts/smoke-reliability.mjs</files>
  <action>Wire `--rerun-failed` flow so the script resolves rerun fixture IDs from the artifact helper before calling `runSmokeSuite`. Set execution mode metadata (for example `mode: rerun-failed`) and ensure fixture selection is strictly failed-only (passed fixtures excluded). Preserve existing non-rerun behavior and existing schema-gate/reporting flow.</action>
  <verify><automated>node --check scripts/smoke-reliability.mjs</automated></verify>
  <done>Smoke script supports rerun mode and executes only failed fixture IDs from the selected artifact.</done>
</task>

<task type="auto">
  <name>Task 2: Add CI-safe rerun error handling and fallback guidance</name>
  <files>scripts/smoke-reliability.mjs</files>
  <action>Implement explicit error branches for artifact-not-found, invalid JSON/schema, and no-rerunnable-failures cases. On these failures, print concise remediation guidance that includes a manual fallback command using `--fixture`. Ensure script returns non-zero exit code for rerun-preflight failures and still attempts to persist a standard smoke artifact payload with diagnostics.</action>
  <verify><automated>node --check scripts/smoke-reliability.mjs && node scripts/smoke-reliability.mjs --dry-run --rerun-failed --artifact /tmp/non-existent-smoke-artifact.json >/tmp/smoke-rerun-preflight.log 2>&1; test $? -ne 0</automated></verify>
  <done>Rerun preflight failures are operator-actionable, emit RESULT fail, and preserve expected CI failure signaling.</done>
</task>

<task type="auto">
  <name>Task 3: Document rerun mode and expose workflow-dispatch controls</name>
  <files>README.md, .github/workflows/reliability-smoke.yml</files>
  <action>Document rerun command examples (`--rerun-failed` with default/latest artifact and optional `--artifact` override), error/fallback behavior, and expected artifact output. Update workflow dispatch inputs to allow optional rerun-mode execution for operators while keeping default scheduled/manual smoke behavior unchanged.</action>
  <verify><automated>rg -n "rerun|--rerun-failed|--artifact" README.md .github/workflows/reliability-smoke.yml scripts/smoke-reliability.mjs</automated></verify>
  <done>Operators have a clear rerun runbook locally and in CI manual dispatch without altering default smoke flow.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] node --check scripts/smoke-reliability.mjs
- [ ] npm run smoke:reliability -- --dry-run --rerun-failed
- [ ] npm run smoke:reliability -- --dry-run --rerun-failed --artifact /tmp/non-existent-smoke-artifact.json (expect non-zero and fallback guidance)
- [ ] test -f .planning/artifacts/smoke/latest.json
- [ ] rg -n "rerun|--rerun-failed|--artifact" README.md .github/workflows/reliability-smoke.yml scripts/smoke-reliability.mjs
</verification>

<success_criteria>

- All plan tasks completed
- Rerun mode reads failed fixtures from latest artifact and ignores passed fixtures
- Missing/invalid artifact states return clear operator guidance and non-zero exit status
- Rerun runs still produce standard smoke artifact output and CI-compatible pass/fail signaling
</success_criteria>

<output>
After completion, create .planning/phases/04-failed-fixture-reruns/04-02-SUMMARY.md
</output>
