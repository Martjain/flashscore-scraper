---
phase: 05-reliability-failure-alerts
plan: "02"
type: execute
wave: 2
depends_on:
  - 05-01
files_modified:
  - scripts/smoke-reliability.mjs
  - scripts/health-selectors.mjs
  - .github/workflows/reliability-smoke.yml
  - README.md
autonomous: true
requirements:
  - RELY-08
must_haves:
  truths:
    - "Smoke and selector-health failing runs each trigger at most one end-of-run alert when alerting is configured"
    - "Success runs remain quiet by default (no routine success or recovery alerts)"
    - "Alert-send failures are logged as warnings and never replace the command's underlying pass/fail exit status"
  artifacts:
    - "scripts/smoke-reliability.mjs triggers alerting only after final smoke result (including schema gate) is known"
    - "scripts/health-selectors.mjs triggers alerting only after final selector-health result is known"
    - ".github/workflows/reliability-smoke.yml exposes webhook env wiring for CI execution"
    - "README.md documents alert configuration, payload expectations, and failure semantics"
  key_links:
    - "final command result -> shouldSendFailureAlert gate -> payload builder -> webhook publisher"
    - "publisher warning result -> console warning output -> unchanged process.exitCode policy"
    - "workflow secret/env -> smoke command runtime -> alert enablement in CI"
---

<objective>
Integrate failure alerting into reliability command entrypoints and operator runbook.

Purpose: Deliver actionable webhook/chat notifications for smoke and selector-health failures without adding noise or changing reliability command exit semantics.
Output: End-of-run alert trigger wiring in both scripts plus CI/documentation configuration guidance.
</objective>

<execution_context>
@./.codex/get-shit-done/workflows/execute-plan.md
@./.codex/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/STATE.md
@.planning/phases/05-reliability-failure-alerts/05-CONTEXT.md
@.planning/phases/05-reliability-failure-alerts/05-RESEARCH.md
@.planning/phases/05-reliability-failure-alerts/05-01-PLAN.md

@scripts/smoke-reliability.mjs
@scripts/health-selectors.mjs
@src/reliability/alerts/index.js
@.github/workflows/reliability-smoke.yml
@README.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire end-of-run failure alerts into smoke command</name>
  <files>scripts/smoke-reliability.mjs</files>
  <action>Integrate shared alerting API after final smoke result is computed and artifact persistence is attempted. Emit at most one alert per failing run (including rerun/preflight failure flow), with source normalized as smoke and affected fixture identifiers derived from final run data. Ensure success runs remain quiet by default, and alert send failures are logged as warnings without mutating smoke exit status semantics.</action>
  <verify><automated>node --check scripts/smoke-reliability.mjs</automated></verify>
  <done>Smoke command can issue one actionable failure alert per failed run while preserving existing RESULT and process exit behavior.</done>
</task>

<task type="auto">
  <name>Task 2: Wire end-of-run failure alerts into selector-health command</name>
  <files>scripts/health-selectors.mjs</files>
  <action>Integrate shared alerting API into selector-health orchestration using normalized source `selector_health`, stage/scope context, and affected scope identifiers from final result/check data. Trigger only for failing runs after report persistence, keep success runs silent by default, and ensure webhook delivery issues remain warning-only with unchanged selector-health pass/fail exit semantics.</action>
  <verify><automated>node --check scripts/health-selectors.mjs</automated></verify>
  <done>Selector-health command emits one end-of-run failure alert with normalized payload and non-blocking delivery behavior.</done>
</task>

<task type="auto">
  <name>Task 3: Document and expose CI webhook configuration for operators</name>
  <files>.github/workflows/reliability-smoke.yml, README.md</files>
  <action>Add/clarify CI environment wiring for webhook alert configuration (using GitHub secret/env), including CI-only default behavior, failure-only trigger semantics, and expected payload fields for triage. Update README runbook with local/CI examples and explicit note that alert-send failures are warning-only and do not mask smoke/health command failures.</action>
  <verify><automated>rg -n "RELIABILITY_ALERT|webhook|failure alert|selector-health|smoke" README.md .github/workflows/reliability-smoke.yml scripts/smoke-reliability.mjs scripts/health-selectors.mjs</automated></verify>
  <done>Operators can configure webhook alerts consistently in CI and understand low-noise behavior plus non-blocking failure semantics.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] node --check scripts/smoke-reliability.mjs scripts/health-selectors.mjs
- [ ] CI=true RELIABILITY_ALERT_WEBHOOK_URL=https://127.0.0.1.invalid npm run smoke:reliability -- --dry-run --fixture does-not-exist --quiet; test $? -ne 0
- [ ] npm run health:selectors -- --dry-run --scope countries --sample 1 --quiet
- [ ] rg -n "RELIABILITY_ALERT|webhook|RESULT:|warning|selector_health|smoke" scripts/smoke-reliability.mjs scripts/health-selectors.mjs README.md .github/workflows/reliability-smoke.yml
</verification>

<success_criteria>

- All plan tasks completed
- Both smoke and selector-health commands trigger end-of-run failure alerts when configured
- Success runs do not emit routine alerts by default
- Alert send failures are visible as warnings and never override command exit status
</success_criteria>

<output>
After completion, create .planning/phases/05-reliability-failure-alerts/05-02-SUMMARY.md
</output>
