---
phase: 02-selector-health-contracts
plan: "02"
type: execute
wave: 2
depends_on:
  - 02-01
files_modified:
  - src/selector-health/health-check/runSelectorHealthCheck.js
  - src/selector-health/health-check/reporting.js
  - src/selector-health/health-check/retention.js
  - scripts/health-selectors.mjs
  - src/cli/arguments/index.js
  - package.json
  - README.md
autonomous: true
requirements:
  - RELY-01
  - RELY-02
must_haves:
  truths:
    - "A selector health-check command validates all critical contracts before full scraping runs"
    - "Strict mode fails on any fallback usage while default mode allows fallback with warning"
    - "Command output includes machine-readable RESULT line and JSON diagnostics with failing keys and page context"
  artifacts:
    - "scripts/health-selectors.mjs exposes health-check CLI with scope/sample/strict/fail-fast/dry-run/report flags"
    - "src/selector-health/health-check/runSelectorHealthCheck.js computes pass/fail and exit semantics"
    - "src/selector-health/health-check/reporting.js and retention.js write latest.json and prune history to 30 reports"
    - "package.json and README.md document npm run health:selectors usage for local and CI strict mode"
  key_links:
    - "selector contracts/resolver from 02-01 -> health-check runner probe loop"
    - "runner result object -> reporting writer -> latest + timestamped report files"
    - "CLI flags -> runner mode/exit behavior -> RESULT line + process exit code"
---

<objective>
Implement selector health-check command execution and diagnostics reporting with strict/default behavior guarantees.

Purpose: Detect selector drift and fallback usage before expensive scraping runs, with actionable diagnostics in both console and JSON artifacts.
Output: `npm run health:selectors` command flow, strict/default mode handling, and report retention behavior.
</objective>

<execution_context>
@./.codex/get-shit-done/workflows/execute-plan.md
@./.codex/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/STATE.md
@.planning/phases/02-selector-health-contracts/02-CONTEXT.md
@.planning/phases/02-selector-health-contracts/02-RESEARCH.md
@.planning/phases/02-selector-health-contracts/02-01-PLAN.md

@src/index.js
@src/cli/arguments/index.js
@package.json
@README.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build selector health-check runner with critical scope probing</name>
  <files>src/selector-health/health-check/runSelectorHealthCheck.js</files>
  <action>Create a runner that probes critical contract keys across requested scopes and samples using Playwright context/pages, supports `--scope` (multi), `--sample`, `--fail-fast`, and `--dry-run`, and computes deterministic outcome fields (`criticalFailures`, `warnings`, `fallbackUsages`, `durationMs`, `result`). Respect mode semantics: default fails only on critical contract breaks; strict fails on any fallback usage.</action>
  <verify><automated>node --check src/selector-health/health-check/runSelectorHealthCheck.js</automated></verify>
  <done>Runner returns a complete per-scope/per-contract outcome payload with strict/default pass-fail decisions matching context policy.</done>
</task>

<task type="auto">
  <name>Task 2: Implement diagnostics reporting, retention, and RESULT summary output</name>
  <files>src/selector-health/health-check/reporting.js, src/selector-health/health-check/retention.js</files>
  <action>Implement reporting helpers that print concise human-readable summary (mode, scopes, pass/fail counts, warnings, fallback count, duration), always include terminal `RESULT: pass|fail`, and write JSON report to configured/default path (.planning/artifacts/selector-health/latest.json) plus timestamped history file. Implement retention pruning to keep latest pointer plus last 30 history reports.</action>
  <verify><automated>node --check src/selector-health/health-check/reporting.js src/selector-health/health-check/retention.js</automated></verify>
  <done>Health-check results are consistently represented in console and JSON artifacts, and old history files are pruned deterministically.</done>
</task>

<task type="auto">
  <name>Task 3: Wire CLI command surface and documentation for local and CI usage</name>
  <files>scripts/health-selectors.mjs, src/cli/arguments/index.js, package.json, README.md</files>
  <action>Add executable health-check entrypoint script and npm command `health:selectors`, parse and validate supported flags, set exit code policy (`0` warnings-only pass, `1` critical/strict fail), and document concrete examples for local scoped run and CI strict run. Keep existing `npm run start` workflow untouched.</action>
  <verify><automated>node --check scripts/health-selectors.mjs src/cli/arguments/index.js && node -e "const p=require('./package.json'); if(!p.scripts || !p.scripts['health:selectors']) process.exit(1);"</automated></verify>
  <done>Users can run `npm run health:selectors` with documented flags, observe RESULT line, and receive correct strict/default exit behavior.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] node --check src/selector-health/health-check/runSelectorHealthCheck.js src/selector-health/health-check/reporting.js src/selector-health/health-check/retention.js scripts/health-selectors.mjs
- [ ] npm run health:selectors -- --dry-run --scope countries --sample 1
- [ ] npm run health:selectors -- --strict --scope match-list --sample 1
- [ ] test -f .planning/artifacts/selector-health/latest.json
</verification>

<success_criteria>

- All plan tasks completed
- Health-check command validates critical selector contracts and returns deterministic exit codes
- Strict mode fails on fallback usage, default mode treats fallback as warning
- Diagnostics reports identify failing keys, attempted selectors, and page context
- Report retention keeps latest plus last 30 timestamped artifacts
</success_criteria>

<output>
After completion, create .planning/phases/02-selector-health-contracts/02-02-SUMMARY.md
</output>
