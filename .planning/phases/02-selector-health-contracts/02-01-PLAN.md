---
phase: 02-selector-health-contracts
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - src/selector-health/contracts/keys.js
  - src/selector-health/contracts/index.js
  - src/selector-health/probe/resolveSelector.js
  - src/selector-health/probe/collectProbeDiagnostics.js
  - src/scraper/services/countries/index.js
  - src/scraper/services/leagues/index.js
  - src/scraper/services/seasons/index.js
  - src/scraper/services/matches/index.js
autonomous: true
requirements:
  - RELY-01
  - RELY-02
must_haves:
  truths:
    - "Critical selector keys for countries, leagues, seasons, match list, and match detail exist in one explicit registry"
    - "Selector lookup for critical keys is deterministic primary->fallback and records the selector index used"
    - "Critical selector misses produce structured diagnostics with scope, key, attempted selectors, and page context"
  artifacts:
    - "src/selector-health/contracts/index.js defines critical contract keys with ordered selectors and scope metadata"
    - "src/selector-health/probe/resolveSelector.js returns matched selector index and failure reason"
    - "scraper services consume shared selector contracts instead of only inline ad hoc selectors"
  key_links:
    - "contract registry -> resolver -> countries/leagues/seasons/matches services"
    - "resolver outcome -> diagnostics collector -> health-check reporting payload"
---

<objective>
Build selector contract foundations and integrate deterministic fallback resolution into critical scraping surfaces.

Purpose: Establish a single source of truth for critical selectors and fallback behavior before adding command-level health checks.
Output: Contract registry, shared selector resolver, and scraper service wiring that emits structured selector diagnostics.
</objective>

<execution_context>
@./.codex/get-shit-done/workflows/execute-plan.md
@./.codex/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/STATE.md
@.planning/phases/02-selector-health-contracts/02-CONTEXT.md
@.planning/phases/02-selector-health-contracts/02-RESEARCH.md

@src/scraper/services/countries/index.js
@src/scraper/services/leagues/index.js
@src/scraper/services/seasons/index.js
@src/scraper/services/matches/index.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create critical selector contract registry and key catalog</name>
  <files>src/selector-health/contracts/keys.js, src/selector-health/contracts/index.js</files>
  <action>Create a selector contract registry for critical scope keys (`countries`, `leagues`, `seasons`, `match-list`, `match-detail`) with deterministic ordered selector candidates (`primary`, fallback1, fallback2 max). Include URL/page intent metadata per key and export immutable contract objects that can be reused by both runtime scraping and health checks.</action>
  <verify><automated>node --check src/selector-health/contracts/keys.js src/selector-health/contracts/index.js</automated></verify>
  <done>All critical selector keys and ordered candidates exist in a shared registry with no key duplication across services.</done>
</task>

<task type="auto">
  <name>Task 2: Implement shared selector resolver with deterministic fallback telemetry</name>
  <files>src/selector-health/probe/resolveSelector.js, src/selector-health/probe/collectProbeDiagnostics.js</files>
  <action>Implement resolver utilities that try selector candidates in fixed order, return matched element metadata plus selector index, and return explicit failure diagnostics when no selector matches. Capture output fields needed by phase context (`scope`, `contractKey`, `selectorsTried`, `matchedSelectorIndex`, `url`, `errorReason`). Ensure fallback count is explicit and strict-mode compatible.</action>
  <verify><automated>node --check src/selector-health/probe/resolveSelector.js src/selector-health/probe/collectProbeDiagnostics.js</automated></verify>
  <done>Resolver utilities provide stable match/failure payloads and include selector-index telemetry for primary vs fallback usage.</done>
</task>

<task type="auto">
  <name>Task 3: Wire contract resolver into critical scraper services</name>
  <files>src/scraper/services/countries/index.js, src/scraper/services/leagues/index.js, src/scraper/services/seasons/index.js, src/scraper/services/matches/index.js</files>
  <action>Replace direct critical selector lookups with contract-driven resolver calls while preserving extraction output schema. Preserve current defensive behavior for missing URLs/match IDs. Ensure each service can emit structured selector diagnostics payloads for downstream health reporting without changing public scraper function signatures.</action>
  <verify><automated>node --check src/scraper/services/countries/index.js src/scraper/services/leagues/index.js src/scraper/services/seasons/index.js src/scraper/services/matches/index.js</automated></verify>
  <done>Critical services resolve selectors through shared contracts and can expose deterministic fallback/failure telemetry without schema regressions.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] node --check src/selector-health/contracts/keys.js src/selector-health/contracts/index.js src/selector-health/probe/resolveSelector.js src/selector-health/probe/collectProbeDiagnostics.js
- [ ] node --check src/scraper/services/countries/index.js src/scraper/services/leagues/index.js src/scraper/services/seasons/index.js src/scraper/services/matches/index.js
- [ ] rg -n "selector-health|contract|fallback" src/scraper/services src/selector-health
</verification>

<success_criteria>

- All plan tasks completed
- Critical selector contracts are centralized and deterministic
- Fallback resolution telemetry includes selector index and failure context
- Scraper services preserve existing data shape while adopting shared contract resolution
</success_criteria>

<output>
After completion, create .planning/phases/02-selector-health-contracts/02-01-SUMMARY.md
</output>
