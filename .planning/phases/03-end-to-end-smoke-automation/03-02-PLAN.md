---
phase: 03-end-to-end-smoke-automation
plan: "02"
type: execute
wave: 2
depends_on:
  - 03-01
files_modified:
  - scripts/smoke-reliability.mjs
  - package.json
  - .github/workflows/reliability-smoke.yml
  - README.md
autonomous: true
requirements:
  - RELY-04
  - RELY-06
must_haves:
  truths:
    - "Schema compatibility validation is a required gate of smoke success"
    - "CI can trigger smoke checks manually and on a schedule"
    - "CI run uses the same smoke command semantics as local execution"
  artifacts:
    - "scripts/smoke-reliability.mjs enforces validate:schema gate before pass result"
    - "package.json exposes a dedicated smoke script command"
    - ".github/workflows/reliability-smoke.yml defines workflow_dispatch and schedule triggers"
    - "README.md documents local and CI smoke usage and runtime controls"
  key_links:
    - "smoke runner output -> schema validator invocation -> final pass/fail decision"
    - "npm smoke script -> GitHub Actions workflow step -> scheduled/manual reliability checks"
    - "artifact path from smoke runner -> workflow artifact upload/debugging"
---

<objective>
Integrate schema-gated smoke execution into CI with manual and scheduled triggers.

Purpose: Make reliability checks continuously enforce extraction + contract compatibility in both local and automated workflows.
Output: Schema-gated smoke command wiring, CI workflow, and operator-facing documentation.
</objective>

<execution_context>
@./.codex/get-shit-done/workflows/execute-plan.md
@./.codex/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/STATE.md
@.planning/phases/03-end-to-end-smoke-automation/03-RESEARCH.md
@.planning/phases/03-end-to-end-smoke-automation/03-01-PLAN.md

@scripts/smoke-reliability.mjs
@scripts/validate-flashscore-schema.mjs
@package.json
@README.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enforce schema validation as required smoke gate</name>
  <files>scripts/smoke-reliability.mjs</files>
  <action>Update smoke command orchestration so that after fixture extraction output is generated, `npm run validate:schema -- <smoke-output-file>` is executed as a required gate. A smoke run must return `fail` when schema validation fails, and artifact payload must include schema gate status and failure diagnostics for traceability.</action>
  <verify><automated>node --check scripts/smoke-reliability.mjs</automated></verify>
  <done>Smoke command cannot report pass unless both extraction-path checks and schema validation pass.</done>
</task>

<task type="auto">
  <name>Task 2: Add CI workflow for manual and scheduled smoke runs</name>
  <files>.github/workflows/reliability-smoke.yml, package.json</files>
  <action>Create a GitHub Actions workflow that installs dependencies, installs Playwright Chromium, runs the smoke command, and uploads smoke artifacts on failure and success. Include `workflow_dispatch` for manual execution and a conservative cron schedule appropriate for routine monitoring. Add `npm run smoke:reliability` script in package.json to standardize invocation between local and CI.</action>
  <verify><automated>node -e "const p=require('./package.json'); if(!p.scripts || !p.scripts['smoke:reliability']) process.exit(1);"</automated></verify>
  <done>CI can execute the same smoke command via manual dispatch and scheduled trigger with deterministic artifact collection.</done>
</task>

<task type="auto">
  <name>Task 3: Document smoke + schema + CI operating workflow</name>
  <files>README.md</files>
  <action>Document local smoke command usage, runtime-budget flags, required schema gate behavior, artifact location, and CI trigger modes (manual/scheduled). Include one local command example and one CI-focused strict command example so operators can reproduce workflow behavior outside CI.</action>
  <verify><automated>rg -n "smoke:reliability|validate:schema|workflow_dispatch|schedule" README.md .github/workflows/reliability-smoke.yml</automated></verify>
  <done>README provides clear runbook coverage for local execution and CI reliability monitoring.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] node --check scripts/smoke-reliability.mjs
- [ ] npm run smoke:reliability -- --dry-run --sample 1
- [ ] npm run smoke:reliability -- --sample 1 --max-matches 1
- [ ] rg -n "workflow_dispatch|schedule|smoke:reliability" .github/workflows/reliability-smoke.yml package.json README.md
</verification>

<success_criteria>

- All plan tasks completed
- Smoke workflow enforces schema validation as a required pass gate
- CI workflow supports both manual dispatch and scheduled reliability monitoring
- Local and CI smoke commands share consistent behavior and artifact output
</success_criteria>

<output>
After completion, create .planning/phases/03-end-to-end-smoke-automation/03-02-SUMMARY.md
</output>
